name: Hourly Push Notifications

on:
  schedule:
    # æ¯æ™‚0åˆ†ã«å®Ÿè¡Œï¼ˆ1æ™‚é–“ã”ã¨ï¼‰
    - cron: '0 * * * *'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

jobs:
  send-notifications:
    runs-on: ubuntu-latest
    
    steps:
      - name: Send push notifications
        run: |
          current_utc_time=$(date -u +"%H:%M")
          current_jst_hour=$(TZ=Asia/Tokyo date +"%H")
          echo "Sending push notifications at UTC: $current_utc_time (JST: ${current_jst_hour}:00)"
          
          # send-push-notificationsã‚’å®Ÿè¡Œ
          response=$(curl -s -X POST '${{ secrets.SUPABASE_URL }}/functions/v1/send-push-notifications' \
            -H 'Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}' \
            -H 'Content-Type: application/json' \
            --data '{}')
          
          echo "Response: $response"
          
          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
          if echo "$response" | grep -q '"success":true'; then
            # é€ä¿¡ã•ã‚ŒãŸé€šçŸ¥æ•°ã‚’æŠ½å‡º
            sent_count=$(echo "$response" | grep -o '"processed":[0-9]*' | cut -d':' -f2)
            results_count=$(echo "$response" | grep -o '"results":\[[^]]*\]' | grep -o '"status":"sent_via_realtime"' | wc -l)
            
            echo "âœ… Push notifications executed successfully"
            echo "ğŸ“Š Processed: $sent_count notifications"
            echo "ğŸ“¨ Sent: $results_count notifications"
            
            if [ "$results_count" -gt 0 ]; then
              echo "ğŸ‰ Notifications delivered to users!"
            else
              echo "â„¹ï¸ No notifications sent (no users scheduled for this hour)"
            fi
          else
            echo "âŒ Push notifications failed"
            echo "$response"
            exit 1
          fi

      - name: Log execution
        run: |
          echo "Hourly push notifications completed at $(TZ=Asia/Tokyo date)"
          echo "Next execution: $(TZ=Asia/Tokyo date -d '+1 hour' +'%Y-%m-%d %H:00')"