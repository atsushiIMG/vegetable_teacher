# やさいせんせい アプリ仕様書

## 📱 アプリ概要

**やさいせんせい** - 家庭菜園初心者向けの栽培管理アプリ

### コアバリュー
- 🔔 **作業を忘れない**：適切なタイミングでプッシュ通知
- 🤖 **AIに相談できる**：分からないことを気軽に質問
- 📸 **成長記録を楽しめる**：パラパラ漫画機能（フェーズ2）

### 技術スタック
- **フロントエンド**: Flutter (Android)
- **バックエンド**: Python FastAPI（AI相談のみ）
- **データベース**: Supabase PostgreSQL
- **認証**: Supabase Auth
- **ストレージ**: Supabase Storage
- **AI**: OpenAI GPT-4o-mini
- **パッケージ名**: `com.atsudev.vegetable_teacher_app`

## 🎯 機能仕様（フェーズ1 MVP）

### 1. 野菜管理機能
- **野菜登録**
  - 12種類から選択：トマト、きゅうり、ナス、オクラ、バジル、サニーレタス、二十日大根、ほうれん草、小カブ、ピーマン、しそ、モロヘイヤ
  - 入力項目：植えた日、種/苗、鉢/畑
- **栽培記録管理**
  - 登録した野菜の一覧表示
  - 各野菜の詳細情報表示

### 2. 通知機能
- **作業通知**：種まき、間引き、支柱立て、追肥、収穫
- **水やり通知**：野菜ごとの基本頻度 × 季節係数
- **通知タイミング**：各野菜の栽培スケジュールに基づく
- **フィードバック収集**：通知後に選択式で状況確認

### 3. AI相談機能
- **テキストベース**の相談チャット
- **野菜ごと**に会話履歴を保持
- **症状・対処法**についてアドバイス

## 📱 画面構成

### 必須画面
1. **認証画面**：ログイン・サインアップ
2. **野菜一覧画面**：栽培中の野菜リスト + 新規追加
3. **野菜詳細画面**：次の作業予定・履歴・AI相談ボタン
4. **AI相談画面**：チャット形式・履歴表示
5. **通知設定画面**：通知時間帯・水やり頻度調整

### 画面遷移フロー
```
ログイン → 野菜一覧 → 野菜詳細 → AI相談
                ↓
              新規追加 → 野菜登録
```

## 🗄️ データベース設計

### テーブル構造
1. **vegetables** - 野菜マスタ（12種類）
2. **user_vegetables** - ユーザーの栽培記録
3. **notifications** - 通知履歴・フィードバック
4. **consultations** - AI相談履歴
5. **photos** - 写真記録（フェーズ2）

### 主要データ例
```json
// 野菜マスタ
{
  "name": "トマト",
  "schedule": {
    "tasks": [
      {"day": 0, "type": "種まき"},
      {"day": 14, "type": "間引き"},
      {"day": 30, "type": "支柱立て"},
      {"day": 90, "type": "収穫"}
    ],
    "watering_base_interval": 2
  }
}
```

## 🔌 API設計

### Python FastAPI エンドポイント
```
POST /api/consultation
{
  "vegetable_type": "トマト",
  "message": "葉っぱが黄色くなってきました",
  "history": [...過去の会話履歴]
}
```

### Supabase Auth
- メール認証
- カスタムURIスキーム：`com.atsudev.vegetable_teacher_app://auth/callback`

## 🔔 通知仕様

### 通知タイミング
- **作業通知**：各野菜の栽培カレンダーに基づく
- **水やり通知**：基本間隔 × 季節係数（夏1.5倍、冬0.7倍等）

### フィードバック選択肢
- 土の状態：「カラカラ」「少し湿ってる」「十分湿ってる」
- 作業完了：「完了」「後で」「スキップ」

## 🔒 セキュリティ・制約

### セキュリティ
- Row Level Security (RLS) 全テーブル適用
- ユーザーは自分のデータのみアクセス可能

### 制約・制限
- 写真サイズ：50MB上限
- AI相談：農業一般知識の範囲内
- 対象OS：Android（フェーズ1）

## 🚀 フェーズ2（将来機能）
- 撮影モード機能
- パラパラ漫画機能
- 収穫記録機能
- カレンダー画面

## 📋 詳細仕様

### 🔔 通知仕様詳細

#### 作業通知タイミング
```
野菜ごとのスケジュール例（トマトの場合）：
- 0日目: 種まき
- 14日目: 間引き  
- 30日目: 支柱立て
- 45日目: 追肥
- 75日目: 追肥（2回目）
- 90日目: 収穫開始
```

#### 水やり通知頻度
- **基本頻度**: 野菜ごとに設定（トマト2日、きゅうり1日等）
- **季節係数**: 
  - 春（3-5月）: 1.0倍
  - 夏（6-8月）: 1.5倍
  - 秋（9-11月）: 1.0倍  
  - 冬（12-2月）: 0.7倍
- **通知時間**: デフォルト朝8:00（ユーザー設定可能）

#### 通知文例
```
作業通知: 「🍅 トマトの間引きの時期です。元気な苗を1本残して他を間引きましょう」
水やり通知: 「💧 トマトの水やり時間です。土の状態を確認してください」
```

### 📝 フィードバック収集詳細

#### フィードバック項目
1. **土の状態**
   - カラカラ → 次回通知を早める（-0.5日）
   - 少し湿ってる → 通常通り
   - 十分湿ってる → 次回通知を遅らせる（+0.5日）

2. **作業完了状況**
   - 完了 → 次のスケジュールに進む
   - 後で → 翌日再通知
   - スキップ → スケジュールを1日遅らせる

#### 📊 高度なフィードバック学習システム

##### 学習データ収集
```json
{
  "feedback_data": {
    "user_vegetable_id": "uuid",
    "notification_type": "水やり",
    "scheduled_time": "2024-04-15T08:00:00Z",
    "user_feedback": {
      "soil_condition": "カラカラ",
      "response_time": 180,
      "action_taken": "完了"
    },
    "environmental_context": {
      "season": "夏",
      "temperature_range": "30-35°C",
      "humidity": "60%",
      "recent_rain": false,
      "days_since_last_watering": 2
    },
    "plant_context": {
      "growth_stage": "開花期",
      "days_since_planting": 45,
      "container_type": "鉢",
      "previous_adjustments": [-0.5, +0.5, 0]
    }
  }
}
```

##### 学習アルゴリズム

**1. 基本調整ロジック**
```
新しい間隔 = 基本間隔 × 季節係数 × 個人調整係数 × 地域係数
```

**2. 個人調整係数の計算**
- 初期値：1.0
- 調整範囲：0.7〜1.3（±30%）
- 更新式：`新係数 = 現係数 × (1 + 調整幅 × 学習率)`
- 学習率：0.1（急激な変化を防ぐ）

**3. フィードバック重み付け**
- 最新7日間：重み1.0
- 8-30日間：重み0.7
- 31日以上：重み0.3

**4. 信頼度スコア**
```
信頼度 = min(フィードバック回数 / 10, 1.0)
調整幅 = 基本調整幅 × 信頼度
```

##### 地域差対応システム

**1. 地域区分**
- 北海道・東北：寒冷地域
- 関東・中部：標準地域  
- 関西・中国・四国：温暖地域
- 九州・沖縄：亜熱帯地域

**2. 地域係数**
```json
{
  "regional_factors": {
    "水やり": {
      "寒冷地域": {"夏": 0.8, "冬": 0.5},
      "標準地域": {"夏": 1.0, "冬": 0.7},
      "温暖地域": {"夏": 1.2, "冬": 0.8},
      "亜熱帯地域": {"夏": 1.5, "冬": 1.0}
    }
  }
}
```

**3. 地域学習データ共有**
- 同じ地域のユーザーデータを匿名化して集約
- 地域平均からの偏差を個人調整に反映
- プライバシー保護：個人を特定できない形での集約

##### 異常値検出・安全機能

**1. 異常値検出**
```python
# 連続して極端なフィードバックの場合
if consecutive_extreme_feedback >= 3:
    send_notification("水やり頻度を確認してください")
    reset_to_base_schedule()
```

**2. 安全上限・下限**
- 水やり最短間隔：12時間
- 水やり最長間隔：7日
- 作業スケジュール調整：±7日以内

**3. 季節移行時の自動調整**
```python
# 季節変わり目に基本設定にリセット
if season_changed():
    personal_factor = 0.8 * personal_factor + 0.2 * 1.0
```

##### 学習効果の可視化

**1. ユーザー画面での表示**
- 「あなたの水やり頻度：標準より20%少なめ」
- 「最近の成功率：85%（良好）」
- 「推奨間隔の変化グラフ」

**2. 学習状況指標**
- 学習完了度：0-100%（フィードバック数に基づく）
- 予測精度：最近の成功率
- 個人化レベル：標準からの偏差

##### データ構造設計

**notifications テーブル拡張**
```sql
ALTER TABLE notifications ADD COLUMN 
  feedback_score FLOAT DEFAULT 0,
  environmental_data JSONB,
  learning_metadata JSONB;
```

**新テーブル：user_learning_profiles**
```sql
CREATE TABLE user_learning_profiles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  vegetable_id UUID REFERENCES vegetables(id),
  personal_factors JSONB, -- 個人調整係数
  learning_stats JSONB,   -- 学習統計
  confidence_scores JSONB, -- 信頼度スコア
  last_updated TIMESTAMP DEFAULT NOW()
);
```

##### 実装段階での考慮事項

**フェーズ1（MVP）**
- 基本的なフィードバック収集（±0.5日調整）
- 最大±30%の調整範囲制限
- シンプルな季節係数適用

**フェーズ2（高度化）**
- 地域差対応システム実装
- 高度な学習アルゴリズム導入
- 異常値検出・安全機能追加
- 学習効果の可視化機能

**フェーズ3（最適化）**
- AI/ML技術による予測精度向上
- 地域コミュニティデータ活用
- 気象データとの連携

### 🤖 AI相談機能の制約・責任範囲

#### 対応可能な相談内容
- 一般的な栽培方法・コツ
- よくある病害虫の症状と対策
- 成長段階に応じたアドバイス
- 基本的なトラブルシューティング

#### 対応不可・制限事項
- 病害虫の確定診断（症状の説明のみ）
- 農薬の具体的な使用指示
- 食品安全に関わる判断
- 緊急性の高い植物の病気

#### 免責事項
```
AI相談は一般的な園芸知識に基づくアドバイスです。
具体的な症状や重要な判断については、
専門家や農協等にご相談ください。
```

### ⚠️ エラーハンドリング方針

#### ネットワークエラー
- オフライン時: ローカルデータで基本機能を継続
- 接続復旧時: 自動同期実行
- AI相談: 「現在接続できません。後でお試しください」

#### 認証エラー  
- セッション切れ: 自動ログイン画面に遷移
- 認証失敗: エラーメッセージ表示とリトライ

#### データエラー
- 野菜データ取得失敗: キャッシュデータを使用
- 通知送信失敗: 次回起動時に再送

### 🔒 データ管理・プライバシー

#### データ保持期間
- **栽培記録**: 削除まで永続保存
- **AI相談履歴**: 野菜ごとに最新50件
- **通知履歴**: 最新3ヶ月分
- **写真**: ユーザー削除まで保存

#### プライバシー配慮
- 個人を特定できる情報は最小限
- AI相談内容のOpenAI側保存は30日間
- ユーザーはいつでもデータ削除可能

### ⚡ パフォーマンス要件

#### レスポンス時間
- 画面遷移: 500ms以内
- AI相談回答: 10秒以内
- データ同期: 5秒以内

#### データ容量
- 写真1枚: 最大50MB
- アプリサイズ: 100MB以下
- 月間データ通信量: 100MB以下（写真除く）

#### 動作環境
- Android 7.0 (API level 24) 以上
- RAM: 最小2GB推奨
- ストレージ: 500MB以上の空き容量